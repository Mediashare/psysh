# Psysh Project Analysis Summary (Generated by Gemini)

This document provides a high-level technical and structural overview of the Psysh project to guide future development.

## Key Technologies

- **Language**: PHP
- **Dependency Management**: Composer
- **Core Components**:
  - `nikic/php-parser`: For Abstract Syntax Tree (AST) parsing and code transformation. This is central to Psysh's functionality.
  - `symfony/console`: Powers the interactive command-line interface (CLI).
  - `symfony/var-dumper`: For rich, colorized output of variables.
- **Quality Assurance**:
  - **Testing**: PHPUnit (`test/` directory).
  - **Static Analysis**: PHPStan and Phan.
  - **Code Style**: StyleCI.

## Core Architecture

Psysh is a modular, object-oriented application with a clear separation of concerns.

- **`Shell.php`**: The main application class that orchestrates the entire Read-Eval-Print-Loop (REPL).
- **`CodeCleaner/`**: A vital component that processes user input. It uses a series of "passes" (AST visitors) to validate, transform, and prepare code for execution (e.g., adding implicit `return` statements).
- **`Command/`**: Contains all the built-in commands like `ls`, `doc`, `history`, and `wtf`. This is the primary entry point for adding new user-facing functionality. Each command extends the base Symfony Command class.
- **`Configuration.php`**: A central object holding all shell configuration, such as casters, matchers, colors, and history settings.
- **`ExecutionLoop/`**: Manages the actual code execution, often forking processes to prevent fatal errors from crashing the main shell.
- **`Readline/` & `TabCompletion/`**: Handle user input, history, and tab-completion logic, with multiple backends for different system environments.

## How to Contribute

- **Adding a New Command**:
  1. Create a new class in `src/Command/` that extends `Psy\Command\Command`.
  2. Implement the `configure()` and `execute()` methods.
  3. The command will be auto-registered by the shell.
  4. Add a corresponding test case in `test/Command/`.

- **Modifying Code Parsing**:
  1. Create a new pass in `src/CodeCleaner/` that extends `Psy\CodeCleaner\CodeCleanerPass`.
  2. Implement the `NodeVisitor` interface methods (e.g., `leaveNode`) to modify the AST.
  3. Register the new pass in the `CodeCleaner` service.
  4. Add relevant tests to cover the new transformation logic.

- **Profiling**:
  1. The `profile` command uses `xhprof` or `Xdebug` to profile code.
  2. The command is located in `src/Command/ProfileCommand.php`.
  3. The command now executes code directly via `Shell::execute`, ensuring the most accurate possible profiling context by using PsySH's own evaluation engine.
  4. This method preserves the entire session context, including variables, user-defined classes, functions, and autoloaders.
  5. The command parses the `xhprof` or `Xdebug` output to display a summary table.
  6. See [PROFILING.md](PROFILING.md) for more details.